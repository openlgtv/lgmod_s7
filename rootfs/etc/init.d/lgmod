#!/bin/sh

BOOT_DIR="/dev/shm/init/lgmod"
MODULES_SH="$BOOT_DIR/module.sh"
MODULES_DIR=/lib/modules
P_SH="$BOOT_DIR/patch.sh"
SRC_DIR="/mnt/lgmod"

CFG_DIR="/mnt/lg/user/lgmod"
S_SH="$CFG_DIR/auto_stop.sh"

do_boot() {
	# lgmod: . /etc/rc.d/rc.local
	local DEBUG=0
	if [ -e $BOOT_DIR/debug ]; then
		DEBUG=1
		rm $BOOT_DIR/debug
		sync
	fi

	# lgmod: . /etc/rc.d/rc.sysinit
	# Copy script for modules loading if not exist (first boot)
	if [ ! -e $MODULES_SH ]; then
		cp -a $SRC_DIR/default-module.sh $MODULES_SH
	fi
	# Load modules with modules script
	(cd $MODULES_DIR; $MODULES_SH)

	# lgmod: . /etc/rc.d/rc.local
	# Copy default patch script
	if [ ! -e $P_SH ]; then
		cp -a $SRC_DIR/default-patch.sh $P_SH
	fi
	# Launch patch script
	$P_SH

	exit $DEBUG
}

do_shutdown() {
	# lgmod: /etc/init.d/rcS
	exec /bin/sh $S_SH
}

do_start() {
	if [ ! -h /mnt/lg/cmn_data/resolv.conf ]; then
		rm /mnt/lg/cmn_data/resolv.conf
		ln -s /tmp/resolv.conf /mnt/lg/cmn_data/
	fi

	# lgmod: /etc/init.d/rcS
	exec /etc/lgmod.sh
}

do_stop() {
	killall udhcpc
	killall ntpd
	killall telnetd
	killall tcpsvd
	killall djmount
	killall httpd
}

case "$1" in
	boot)
		do_boot
		;;
	shutdown)
		do_shutdown
		;;
	start)
		do_start
		;;
	stop)
		do_stop
		;;
	restart)
		do_stop
		do_start
		;;
	*)
		echo "Usage: $0 {boot|start|stop|restart}"
		exit 1
esac
